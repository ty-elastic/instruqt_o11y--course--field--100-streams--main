source /opt/workshops/elastic-retry.sh
export $(curl http://kubernetes-vm:9000/env | xargs)

export INSTRUQT_TRACK_SLUG=o11y--course--field--100-streams--main
export GITHUB_REPO=https://github.com/ty-elastic/instruqt_o11y--course--field--100-streams--main

# ------------- CODE

mkdir -p /workspace/workshop
git clone $GITHUB_REPO /workspace/workshop
cd /workspace/workshop

# ------------- VIEW

source /workspace/workshop/instruqt/scripts/elastic-view.sh

# ------------- AI ASSISTANT

source /workspace/workshop/instruqt/scripts/elastic-completion.sh

# ------------- STREAMS

source /workspace/workshop/instruqt/scripts/elastic-streams.sh

# ------------- OTEL

source /workspace/workshop/instruqt/scripts/elastic-otel.sh -n trading

# ------------- DEPLOY

./deploy.sh -s trading-logen -o false -c $INSTRUQT_TRACK_SLUG -v $INSTRUQT_TRACK_SLUG

# ------------- WAIT

retry_command_lin curl --silent --fail --output /dev/null --header "Authorization: Basic $ELASTICSEARCH_AUTH_BASE64" "$ELASTICSEARCH_URL/_cat/indices/logs-proxy.otel-default?allow_no_indices=false"

curl -X POST "$ELASTICSEARCH_URL/logs-proxy.otel-default/_rollover" \
    --header 'Content-Type: application/json' \
    --header "Authorization: Basic $ELASTICSEARCH_AUTH_BASE64"

echo "Wait for realtime"
retry_command_lin curl --silent --fail --output /dev/null http://kubernetes-vm:32003/status/realtime
echo "realtime reached"

